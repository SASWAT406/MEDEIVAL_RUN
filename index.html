<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Medieval Knight: Broken Cart Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050510; font-family: 'Courier New', serif; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* HUD */
        #run-score-box {
            position: absolute; top: 20px; left: 80px; 
            color: #ffffff; font-size: 24px; font-weight: bold;
            text-shadow: 0 0 5px #ffffff;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 5px;
            border-left: 3px solid #e74c3c;
        }

        #diamond-box {
            position: absolute; top: 20px; right: 20px;
            color: #00ffff; font-size: 24px; font-weight: bold;
            text-shadow: 0 0 5px #00ffff;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 5px;
            border-right: 3px solid #00ffff;
        }

        /* PAUSE BUTTON */
        #pause-btn {
            position: absolute; top: 20px; left: 20px;
            background: #8e44ad; color: white; border: 2px solid #fff;
            width: 50px; height: 50px; border-radius: 50%;
            font-size: 20px; font-weight: bold; cursor: pointer;
            pointer-events: auto; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 10px rgba(142, 68, 173, 0.8);
            transition: transform 0.2s;
        }
        #pause-btn:hover { transform: scale(1.1); background: #9b59b6; }

        /* SCREENS */
        #menu-screen, #pause-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; z-index: 10; text-align: center;
        }

        #pause-screen { display: none; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }

        h1 { color: #e74c3c; font-size: 60px; margin: 0; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 20px #e74c3c; }
        h2 { color: #888; font-size: 18px; margin-bottom: 30px; font-style: italic; }
        
        .controls { color: #ddd; margin-bottom: 30px; font-size: 16px; line-height: 1.6; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; }
        .key { color: #ffd700; font-weight: bold; }

        .btn-main {
            background: #8e44ad; color: #fff; border: 2px solid #e74c3c;
            padding: 15px 60px; font-size: 24px; cursor: pointer;
            text-transform: uppercase; font-weight: bold; box-shadow: 0 0 15px #e74c3c;
            margin-top: 10px; transition: transform 0.1s;
        }
        .btn-main:hover { background: #9b59b6; transform: scale(1.05); }
        
        /* RESULT STATS */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 30px; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;
        }
        .stat-item { font-size: 20px; color: #fff; text-align: left; }
        .stat-val { font-weight: bold; color: #ffd700; float: right; }

        #game-over-title { display: none; color: red; font-size: 50px; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 20px red; }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <button id="pause-btn" onclick="togglePause()">||</button>

    <div id="ui-layer">
        <div id="run-score-box">SCORE: <span id="run-score-val">0</span></div>
        <div id="diamond-box">DIAMONDS: <span id="diamond-val">0</span></div>

        <div id="pause-screen">
            <h1>PAUSED</h1>
            <button class="btn-main" onclick="togglePause()">RESUME</button>
        </div>

        <div id="menu-screen">
            <div id="game-over-title">THE PHANTOM CAUGHT YOU!</div>
            
            <h1 id="main-title">Dungeon Run</h1>
            <h2 id="sub-title">Escape the Spirit Guardian</h2>
            
            <div id="results-panel" style="display:none;" class="stats-grid">
                <div class="stat-item">Distance Run: <span id="final-run-score" class="stat-val">0</span></div>
                <div class="stat-item">Diamonds: <span id="final-diamond-score" class="stat-val">0</span></div>
            </div>

            <div id="controls-panel" class="controls">
                <span class="key">⬆ UP</span> to Jump<br>
                <span class="key">⬇ DOWN</span> to Slide<br>
                <span class="key">⬅ ➡ SIDES</span> to Dodge<br>
                <span class="key">P</span> to Pause
            </div>

            <button class="btn-main" onclick="startGame()">ENTER DUNGEON</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const CONFIG = {
            laneWidth: 4.0,
            startSpeed: 0.35,  
            maxSpeed: 0.90,    
            jumpForce: 0.72,
            gravity: 0.038,
            fogColor: 0x101025,
            chaserStartZ: 6,
            chaserFarZ: 35
        };

        // --- 2. GLOBAL VARIABLES ---
        var scene, camera, renderer;
        var playerGroup, chaserGroup;
        var limbs = {};
        var obstacles = [];
        var coins = [];
        var floorSegments = [];
        var torches = []; 
        var isPlaying = false;
        var isGameOver = false;
        var isPaused = false;
        
        var runScore = 0;      
        var diamondScore = 0;  
        var gameSpeed = CONFIG.startSpeed;
        var frameCount = 0;

        // Physics
        var currentLane = 0;
        var playerY = 0;
        var verticalVel = 0;
        var isJumping = false;
        var isSliding = false;
        var slideTimer = 0;

        // Chaser
        var chaserOffset = CONFIG.chaserStartZ;
        var chaserTarget = CONFIG.chaserStartZ;

        window.onload = function() { init(); };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.fogColor);
            scene.fog = new THREE.Fog(CONFIG.fogColor, 15, 90);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 500);
            camera.position.set(0, 6, -12);
            camera.lookAt(0, 2, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            createMaterials();
            setupLighting();
            createKnight();
            createChaser();

            for(var i=-2; i<8; i++) spawnFloor(i * 100);

            document.addEventListener('keydown', handleKey);
            window.addEventListener('resize', onResize);
            
            animate();
        }

        var MAT = {};
        function createMaterials() {
            MAT.armor = new THREE.MeshLambertMaterial({ color: 0xeeeeee });
            MAT.dark = new THREE.MeshLambertMaterial({ color: 0x333333 });
            MAT.red = new THREE.MeshBasicMaterial({ color: 0xcc0000 });
            MAT.wood = new THREE.MeshLambertMaterial({ color: 0x7d5037 });
            MAT.brokenWood = new THREE.MeshLambertMaterial({ color: 0x5a3a2a }); // Darker for broken bits
            MAT.stone = new THREE.MeshLambertMaterial({ color: 0x555555 });
            MAT.bone = new THREE.MeshLambertMaterial({ color: 0xffffff }); 
            MAT.fire = new THREE.MeshBasicMaterial({ color: 0xff8800 });
            MAT.ghost = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.9 });
            MAT.glow = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            MAT.diamond = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            MAT.iron = new THREE.MeshLambertMaterial({ color: 0x222222 });
        }

        function setupLighting() {
            var ambient = new THREE.AmbientLight(0x444466, 0.8);
            scene.add(ambient);
            
            var playerLight = new THREE.PointLight(0xffaa00, 1.5, 30);
            playerLight.position.set(0, 5, 5);
            camera.add(playerLight); 
            scene.add(camera);

            var rimLight = new THREE.DirectionalLight(0x6666ff, 0.6);
            rimLight.position.set(0, 10, -20);
            scene.add(rimLight);
        }

        // --- CHARACTERS ---
        function createKnight() {
            playerGroup = new THREE.Group();
            var torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 0.6), MAT.armor);
            torso.position.y = 1.4; playerGroup.add(torso);
            var head = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), MAT.armor);
            head.position.y = 2.5; playerGroup.add(head);
            var plume = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.4, 0.4), MAT.red);
            plume.position.set(0, 3.0, -0.2); playerGroup.add(plume);

            function makeLimb(x, y, mat) {
                var g = new THREE.Group(); g.position.set(x, y, 0);
                var m = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.0, 0.3), mat);
                m.position.y = -0.5; g.add(m); return g;
            }
            limbs.armL = makeLimb(-0.7, 2.0, MAT.armor); playerGroup.add(limbs.armL);
            limbs.armR = makeLimb(0.7, 2.0, MAT.armor); playerGroup.add(limbs.armR);
            limbs.legL = makeLimb(-0.3, 0.8, MAT.dark); playerGroup.add(limbs.legL);
            limbs.legR = makeLimb(0.3, 0.8, MAT.dark); playerGroup.add(limbs.legR);
            scene.add(playerGroup);
        }

        function createChaser() {
            chaserGroup = new THREE.Group();
            var body = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 8), MAT.ghost);
            body.position.y = 2.5; chaserGroup.add(body);
            var head = new THREE.Mesh(new THREE.SphereGeometry(0.8, 8, 8), MAT.ghost);
            head.position.y = 4.0; chaserGroup.add(head);
            var eyeL = new THREE.Mesh(new THREE.SphereGeometry(0.12), MAT.glow);
            eyeL.position.set(-0.3, 4.0, 0.6); chaserGroup.add(eyeL);
            var eyeR = new THREE.Mesh(new THREE.SphereGeometry(0.12), MAT.glow);
            eyeR.position.set(0.3, 4.0, 0.6); chaserGroup.add(eyeR);
            scene.add(chaserGroup);
        }

        // --- DECORATIONS ---
        function createSkull() {
            var g = new THREE.Group();
            var head = new THREE.Mesh(new THREE.SphereGeometry(0.35, 6, 6), MAT.bone); g.add(head);
            var jaw = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.25, 0.3), MAT.bone); jaw.position.y = -0.35; g.add(jaw);
            var eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.05), MAT.dark); eyeL.position.set(-0.12, 0, 0.3); g.add(eyeL);
            var eyeR = eyeL.clone(); eyeR.position.set(0.12, 0, 0.3); g.add(eyeR);
            return g;
        }

        function createWallTorch() {
            var g = new THREE.Group();
            var stick = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8), MAT.wood);
            stick.rotation.x = Math.PI / 4; stick.position.z = 0.4; g.add(stick);
            var flame = new THREE.Mesh(new THREE.DodecahedronGeometry(0.2), MAT.fire);
            flame.position.set(0, 0.3, 0.7); g.add(flame);
            torches.push({ mesh: flame, offset: Math.random() * 10 });
            return g;
        }

        // --- NEW BROKEN CART GENERATOR ---
        function createBrokenCart() {
            var g = new THREE.Group();
            
            // 1. Main Base (Tilted)
            var base = new THREE.Mesh(new THREE.BoxGeometry(3.0, 0.4, 5.0), MAT.brokenWood);
            base.position.y = 0.5;
            base.rotation.z = (Math.random() - 0.5) * 0.4; // Random Tilt
            base.rotation.y = (Math.random() - 0.5) * 0.2; // Random Yawn
            g.add(base);

            // 2. Broken Side Planks (Sticking up)
            var p1 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.5, 4.5), MAT.wood);
            p1.position.set(-1.4, 1.2, 0);
            p1.rotation.z = -0.2 + Math.random() * 0.2;
            g.add(p1);

            var p2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.0, 4.5), MAT.wood);
            p2.position.set(1.4, 1.0, 0);
            p2.rotation.z = 0.3 + Math.random() * 0.2;
            g.add(p2);

            // 3. Debris (Random blocks)
            for(var k=0; k<3; k++) {
                var d = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 1.5), MAT.wood);
                d.position.set((Math.random()-0.5)*2, 0.6, (Math.random()-0.5)*4);
                d.rotation.set(Math.random(), Math.random(), Math.random());
                g.add(d);
            }

            // 4. Broken Wheels
            var wGeo = new THREE.CylinderGeometry(0.8, 0.8, 0.3, 16);
            wGeo.rotateZ(Math.PI/2);
            
            // Attached Wheel
            var w1 = new THREE.Mesh(wGeo, MAT.iron);
            w1.position.set(-1.6, 0.8, 1.5);
            g.add(w1);

            // Detached/Fallen Wheel
            var w2 = new THREE.Mesh(wGeo, MAT.iron);
            w2.position.set(2.0, 0.4, -1.0);
            w2.rotation.x = Math.PI/2; // Lying flat
            w2.rotation.z = Math.random();
            g.add(w2);

            return g;
        }

        function createLog() {
            var g = new THREE.Group();
            var m = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 3.5, 8), MAT.wood);
            m.rotation.z = Math.PI/2; m.position.y = 0.5; g.add(m);
            return g;
        }
        function createBeam() {
            var g = new THREE.Group();
            var top = new THREE.Mesh(new THREE.BoxGeometry(3.8, 0.6, 0.6), MAT.wood);
            top.position.y = 2.4; g.add(top);
            var l1 = new THREE.Mesh(new THREE.BoxGeometry(0.4, 3, 0.4), MAT.wood);
            l1.position.set(-1.7, 1.5, 0); g.add(l1);
            var l2 = l1.clone(); l2.position.set(1.7, 1.5, 0); g.add(l2);
            return g;
        }

        // --- 7. SPAWNING ---
        function spawnFloor(zPos) {
            var g = new THREE.Group();
            var road = new THREE.Mesh(new THREE.PlaneGeometry(30, 100), new THREE.MeshLambertMaterial({color:0x2e1e17}));
            road.rotation.x = -Math.PI/2; g.add(road);
            var wallGeo = new THREE.BoxGeometry(2, 10, 20);
            for(var i=0; i<5; i++) {
                var z = (i*20) - 40;
                var w1 = new THREE.Mesh(wallGeo, MAT.stone); w1.position.set(-16, 5, z); g.add(w1);
                var w2 = new THREE.Mesh(wallGeo, MAT.stone); w2.position.set(16, 5, z); g.add(w2);
                if(i % 2 === 0) {
                    var tL = createWallTorch(); tL.position.set(-14.8, 6, z); tL.rotation.y = Math.PI/2; g.add(tL);
                    var tR = createWallTorch(); tR.position.set(14.8, 6, z); tR.rotation.y = -Math.PI/2; g.add(tR);
                } else {
                    var sL = createSkull(); sL.position.set(-14.9, 6, z); sL.rotation.y = Math.PI/2; g.add(sL);
                    var sR = createSkull(); sR.position.set(14.9, 6, z); sR.rotation.y = -Math.PI/2; g.add(sR);
                }
            }
            g.position.z = zPos + 50; scene.add(g); floorSegments.push(g);
            if(zPos > 50) spawnObstacles(zPos);
        }

        function spawnObstacles(baseZ) {
            for(var i=1; i<5; i++) {
                var z = baseZ + (i*20);
                var lane = Math.floor(Math.random()*3)-1;
                var type = Math.random();
                if(type < 0.5) { 
                    var d = new THREE.Mesh(new THREE.OctahedronGeometry(0.5), MAT.diamond);
                    d.position.set(lane*CONFIG.laneWidth, 1.5, z);
                    coins.push(d); scene.add(d);
                } 
                else if(type < 0.65) {
                    var o = createLog(); o.position.set(lane*CONFIG.laneWidth, 0, z);
                    obstacles.push({mesh:o, type:'JUMP'}); scene.add(o);
                } 
                else if(type < 0.8) {
                    var o = createBeam(); o.position.set(lane*CONFIG.laneWidth, 0, z);
                    obstacles.push({mesh:o, type:'SLIDE'}); scene.add(o);
                } 
                else {
                    // NEW BROKEN CART
                    var o = createBrokenCart(); o.position.set(lane*CONFIG.laneWidth, 0, z);
                    obstacles.push({mesh:o, type:'BLOCK'}); scene.add(o);
                }
            }
        }

        // --- 8. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            if (isPaused) return;

            if (!isPlaying && !isGameOver) {
                renderer.render(scene, camera);
                return;
            }

            if (isPlaying && !isGameOver) {
                frameCount++;
                
                // SCORE & SPEED
                runScore = Math.floor(playerGroup.position.z / 10);
                document.getElementById('run-score-val').innerText = runScore;

                var speedIncrease = runScore * 0.0002;
                gameSpeed = Math.min(CONFIG.maxSpeed, CONFIG.startSpeed + speedIncrease);

                // MOVE PLAYER
                playerGroup.position.z += gameSpeed;
                var tx = currentLane * CONFIG.laneWidth;
                playerGroup.position.x += (tx - playerGroup.position.x) * 0.15;

                // CHASER
                if (chaserTarget < CONFIG.chaserFarZ) chaserTarget += 0.05;
                chaserOffset += (chaserTarget - chaserOffset) * 0.02;
                chaserGroup.position.z = playerGroup.position.z - chaserOffset;
                chaserGroup.position.x += (playerGroup.position.x - chaserGroup.position.x) * 0.05;
                chaserGroup.position.y = 2 + Math.sin(frameCount * 0.05) * 0.5;

                // KNIGHT ANIM
                if (!isJumping && !isSliding) {
                    var s = 0.25 + (gameSpeed * 0.2); 
                    limbs.legL.rotation.x = Math.sin(frameCount*s);
                    limbs.legR.rotation.x = Math.sin(frameCount*s + Math.PI);
                    limbs.armL.rotation.x = Math.sin(frameCount*s + Math.PI);
                    limbs.armR.rotation.x = Math.sin(frameCount*s);
                    playerGroup.position.y = playerY + Math.abs(Math.sin(frameCount*s)*0.1);
                } else {
                    limbs.legL.rotation.x = -0.2; limbs.legR.rotation.x = 0.2;
                    limbs.armL.rotation.x = -2.0; limbs.armR.rotation.x = -2.0;
                }

                // TORCH FLICKER
                var time = Date.now() * 0.005;
                for(var t of torches) {
                    var scale = 1.0 + Math.sin(time + t.offset) * 0.2;
                    t.mesh.scale.set(scale, scale, scale);
                }

                // PHYSICS
                playerY += verticalVel;
                if (playerY > 0) { verticalVel -= CONFIG.gravity; isJumping = true; } 
                else { playerY = 0; verticalVel = 0; isJumping = false; }

                if (isSliding) {
                    playerGroup.rotation.x = -Math.PI/3; playerGroup.position.y = 0.5;
                    slideTimer--;
                    if(slideTimer<=0) { isSliding=false; playerGroup.rotation.x = 0; }
                } else {
                    playerGroup.position.y = playerY;
                }

                // CAMERA
                camera.position.z = playerGroup.position.z - 12;
                camera.position.x = playerGroup.position.x * 0.5;

                if (playerGroup.position.z > floorSegments[0].position.z + 50) {
                    var old = floorSegments.shift(); scene.remove(old);
                    var lastZ = floorSegments[floorSegments.length - 1].position.z;
                    spawnFloor(lastZ + 50);
                }

                checkCollisions();
                checkCoins();
            } else if (isGameOver) {
                // Game Over Animation
                chaserGroup.position.z += 0.2;
                if(chaserGroup.position.z > playerGroup.position.z) chaserGroup.position.z = playerGroup.position.z;
                chaserGroup.position.x = playerGroup.position.x;
                chaserGroup.position.y = 3;
            }

            renderer.render(scene, camera);
        }

        function checkCoins() {
            for(var i=coins.length-1; i>=0; i--) {
                coins[i].rotation.y += 0.05;
                if(coins[i].position.distanceTo(playerGroup.position) < 2.5) {
                    scene.remove(coins[i]); coins.splice(i,1);
                    diamondScore++; 
                    document.getElementById('diamond-val').innerText = diamondScore;
                }
            }
        }

        function checkCollisions() {
            for(var i=0; i<obstacles.length; i++) {
                var obs = obstacles[i];
                if(Math.abs(obs.mesh.position.z - playerGroup.position.z) < 1.0) {
                    if(Math.abs(obs.mesh.position.x - playerGroup.position.x) < 1.5) {
                        var safe = false;
                        if(obs.type === 'JUMP' && playerY > 1.0) safe = true;
                        if(obs.type === 'SLIDE' && isSliding) safe = true;
                        if(!safe) gameOver();
                    }
                }
            }
        }

        function togglePause() {
            if (isGameOver) return;
            isPaused = !isPaused;
            document.getElementById('pause-screen').style.display = isPaused ? 'flex' : 'none';
            document.getElementById('pause-btn').innerText = isPaused ? '▶' : '||';
        }

        function startGame() {
            document.getElementById('menu-screen').style.display = 'none';
            isPlaying = true;
            isGameOver = false;
            chaserTarget = CONFIG.chaserFarZ;
        }

        function gameOver() {
            isGameOver = true;
            isPlaying = false;
            document.getElementById('menu-screen').style.display = 'flex';
            document.getElementById('game-over-title').style.display = 'block';
            document.getElementById('main-title').style.display = 'none';
            document.getElementById('sub-title').style.display = 'none';
            document.getElementById('controls-panel').style.display = 'none';
            document.getElementById('results-panel').style.display = 'grid';
            document.getElementById('final-run-score').innerText = runScore;
            document.getElementById('final-diamond-score').innerText = diamondScore;
            var btn = document.querySelector('.btn-main');
            btn.innerText = "RESURRECT";
            btn.onclick = function() { location.reload(); };
        }

        function handleKey(e) {
            if (e.key === 'p' || e.key === 'P') { togglePause(); return; }
            if(!isPlaying || isPaused) return;
            if (e.key === 'ArrowRight' && currentLane > -1) currentLane--; 
            if (e.key === 'ArrowLeft' && currentLane < 1) currentLane++; 
            if ((e.key === 'ArrowUp' || e.code === 'Space') && !isJumping) verticalVel = CONFIG.jumpForce;
            if (e.key === 'ArrowDown' && !isJumping && !isSliding) { isSliding = true; slideTimer = 40; }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
